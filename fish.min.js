console.clear();var Game=function(){var t,e,n,i,a,o,s,r,l,y,p,c=document.getElementById("ui"),x=document.getElementById("sea"),h=x.getContext("2d"),u=[],d=100,f=75,w="start",m=[],v=[],g=[],b=[],M=[],S=[],k=!1,C=[],P=[],T=[],I=[],E=0,N="0000000005500000000000000000055235555000000000000000553333350000000000000005255555500000000000005551111455000000000055111224444450000555054122233345555500052354222333344111115000533333333334115115150052333333344411511515000533223444441151151555505223444334411111505115544444333344444225521144443322222223332505113233322222222255500051233322222222222250052225332221111223350052255055521111115550000550000005555555000000000000000523335000000000000000052555000000000000000055500000000000",L={start:function(){z.welcome(),z.menu(),z.extras(),z.highscores(),z.help(),z.tuto(),z.over(),z.win(),z.bubbles(),z.audio(),z.scores(),window.addEventListener("resize",L.resize),document.addEventListener("touchmove",L.noScroll),x.addEventListener("click",B),x.addEventListener("touchstart",B),W(0,L.resize),W(.5,L.intro)},intro:function(){requestAnimationFrame(V.frame),t.show(),W(1,function(){t.down(),e.show()})},resize:function(){clearTimeout(L.resizeT),R(c,"resize"),L.resizeT=setTimeout(function(){x.width=c.clientWidth,x.height=c.clientHeight,y=x.width/d,p=x.height/f,H(I,function(){this.el.style["font-size"]=x.width/40+"px"}),q(c,"resize"),scrollTo(0,1)},420)},clear:function(){k&&H(C,function(t){t.s*=-1}),k=!1,q(c,"dead"),q(c,"breath"),L.bright=0,te.reset(),l=null,H(T,function(t){clearTimeout(t)}),T=[],m=[],b=[],M=[],S=[],g=[],v=[]},over:function(){ee.el.textContent="",te.el.textContent="",s.score.innerHTML="Score: "+ee.val+"<br>"+g.length+"/"+$.lvls[$.current].score,te.silence(),ce.play("game",pe,100),w="over",R(c,"dead"),s.show()},win:function(){w="win",ee.stop(),ee.el.textContent="",te.el.textContent="",te.silence(),ce.play("game",oe,100),r.empty(),l.sx=!1,l.sy=!1,H(v,function(){this.move(l.x,l.y)}),H(b,function(){this.rotate=0,this.sx=!1,this.sy=!1}),$.current<$.lvls.length-1?(r.text(["<h1>Level "+($.current+1)+"</h1>","<h2>You did it!</h2>","<p>Score: "+ee.val+"</p>","<p>Time: "+ee.time.toFixed(2)+" sec</p>"]),r.button("Next Level",function(){$.current++,r.up(),$.current<2?(o.update(),o.show()):W(.5,$.build)})):L.end(),r.show()},end:function(){r.text(["<h2>You Win!</h2>","<p>Final Score: "+ee.total+"</p>","<p>Total Time: "+ee.totaltime.toFixed(2)+" sec</p>","<p>Enter your name:</p>"]),r.player=document.createElement("input");var t=localStorage.getItem("kfish name");t&&(r.player.value=t),r.player.type="text",r.player.maxLength=8,r.el.appendChild(r.player),r.button("Save",function(){var t=r.player.value;t?localStorage.setItem("kfish name",t):t="Player1",ee.highscore(t,ee.total,ee.totaltime),r.up(),i.show(),L.reset(),L.resize()})},reset:function(){$.current=0,q(c,"dead"),w="start",ee.total=0,ee.totaltime=0,k&&H(C,function(t){t.s*=-1})},noScroll:function(t){t.preventDefault()}},z={welcome:function(){t=new D("welcome"),R(t.el,"up"),t.text("<h1>kfish</h1>")},menu:function(){e=new D("menu"),R(e.el,"up"),e.button("Play",function(){e.up(),o.update(),o.show()}),e.button("Help",function(){e.down(),a.show()}),e.button("Highscores",function(){e.down(),i.show()}),e.button("Extras",function(){e.down(),n.show()})},extras:function(){n=new D("extras"),R(n.el,"up"),n.button("Made for JS13K",function(){open("http://js13kgames.com","_blank")}),n.button("Source Code",function(){open("http://github.com/rafaelcastrocouto/kfish","_blank")}),n.button("Credits",function(){open("http://codepen.io/rafaelcastrocouto/blog","_blank")}),n.button("Back",function(){e.show(),n.up()})},help:function(){a=new D("help"),R(a.el,"up"),a.text(["<p>Click to swim</p>","<p>Double click to jump</p>","<p>Dodge orange enemies</p>","<p>Grab green speed bonus</p>","<p>Red circles reverses</p>","<p>Watch your breath</p>","<p>Catch all little fishes!</p>"]),a.button("Back",function(){e.show(),a.up()})},highscores:function(){i=new D("high"),R(i.el,"up"),i.data=[{name:"Player1",points:6,time:10},{name:"Player1",points:5,time:10},{name:"Player1",points:4,time:10},{name:"Player1",points:3,time:10},{name:"Player1",points:2,time:10},{name:"Player1",points:1,time:10},{name:"Player1",points:0,time:10}],ee.load(),ee.build()},tuto:function(){var t=[["<p>Catch 3 fishes!</p>","<p>Dodge orange<br>enemies</p>","<p>Red circles reverses</p>"],["<p>Double click to jump</p>","<p>Grab green<br>speed bonus</p>","<p>Watch your breath</p>"]];o=new D("tuto"),R(o.el,"up"),o.update=function(){o.empty(),o.text(t[$.current]||"<p>Get ready!</p>"),o.button("Ok",function(){o.up(),W(.5,$.build)})},o.update()},win:function(){r=new D("win"),R(r.el,"down")},over:function(){s=new D("over"),R(s.el,"down"),s.text("<h2>Game Over</h2>"),s.score=document.createElement("p"),s.score.textContent="Score: 0",s.el.appendChild(s.score),s.button("Try again",function(){s.up(),W(.5,$.build)}),s.button("Back",function(){s.up(),e.show(),L.reset()})},bubbles:function(){for(var t=0;64>t;t++)C.push({x:A(-5,d+5),y:A(0,f+10),w:A(2,10),s:A(.05,.3),r:A(0,50)})},splash:function(t,e,n){var i,a,o,s=3,r=16;for(n&&(r=20,s=3.5),o=0;r>o;o++)a=A(0,2*Math.PI),i=A(.2,.5),P.push({x:t,y:e,w:A(s,2*s),s:i,sx:Math.sin(a)*i,sy:Math.cos(a)*i})},audio:function(){window.AudioContext&&(ce.load(),L.audio=!0,ce.el=document.createElement("a"),R(ce.el,"mute"),ce.el.textContent=ce.mute?ce.playStr:ce.muteStr,ce.el.addEventListener("click",ce.mute),I.push(ce),c.appendChild(ce.el),ce.context=new AudioContext,ce.gainNode=ce.context.createGain(),ce.gainNode.connect(ce.context.destination),z.oscillator())},oscillator:function(){ce.oscillator=ce.context.createOscillator(),ce.oscillator.frequency.value=0,ce.oscillator.detune.value=0,ce.oscillator.type="sine",ce.oscillator.connect(ce.gainNode),ce.oscillator.start(0)},scores:function(){ee.el=document.createElement("span"),R(ee.el,"score"),c.appendChild(ee.el),I.push(ee),te.el=document.createElement("span"),R(te.el,"shoalscore"),c.appendChild(te.el),I.push(te)},sprite:function(t,e,n,i){var a=document.createElement("canvas"),o=a.getContext("2d"),s=0;a.width=t,a.height=e;for(var r=0;e>r;r++)for(var l=0;t>l;l++)o.fillStyle=i[Number(n[s])],o.fillRect(l,r,1,1),s++;return a}},D=function(t){this.el=document.createElement("div"),R(this.el,"box"),R(this.el,t),c.appendChild(this.el),u.push(this),I.push(this)};D.prototype.button=function(t,e){var n=document.createElement("div");return n.textContent=t,R(n,"button"),n.addEventListener("click",function(){ce.play("game",ae,120),e()}),this.el.appendChild(n),n},D.prototype.text=function(t){var e=t;t instanceof Array&&(e=t.join("")),this.el.innerHTML=e},D.prototype.show=function(){q(this.el,"up"),q(this.el,"down")},D.prototype.up=function(){R(this.el,"up")},D.prototype.down=function(){R(this.el,"down")},D.prototype.empty=function(){for(;this.el.firstChild;)this.el.removeChild(this.el.firstChild)};var j=function(t){this.x=t.x,this.y=t.y,this.px=t.x,this.py=t.y,this.dx=t.dx||!1,this.dy=t.dy||!1,this.w=t.w,this.h=t.h||t.w,this.s=t.s,this.r=t.r||t.w,t.rotate&&(this.rotate=t.rotate),m.push(this)},O=function(t,e){j.call(this,t),this.type="fish",this.img=t.img,e||v.push(this)};O.prototype.move=function(t,e,n){n&&z.splash(this.x,this.y),this.pdx=t,this.pdy=e;var i=this.pdx-this.x,a=this.pdy-this.y,o=Math.atan2(a,i);this.sx=Math.abs(this.s*Math.cos(o)),this.sy=Math.abs(this.s*Math.sin(o)),this.flip=t<this.x},O.prototype.jump=function(t,e,n){z.splash(t,e,!0),this.x=t,this.y=e,n?(this.px=t,this.py=e):(this.px=t+A(2,4,!0),this.py=e+A(2,4,!0)),this.sx=0,this.sy=0,this.pdx=!1,this.pdy=!1},O.prototype.addToShoal=function(){ce.play("shoal",se,150),J(v,this),g.push(this),this.img=U.shoal,this.move(l.x+A(0,4,!0),l.y+A(0,4,!0)),this.rotate=A(.01,.04,!0),ee.update(2),L.bright||(L.bright=1,W(.3,function(){L.bright=0}))};var F=function(t){j.call(this,t),this.type="power";var e=(this.dx-this.x,this.dy-this.y,Math.atan2(this.dy,this.dx));this.sx=Math.abs(this.s*Math.cos(e)),this.sy=Math.abs(this.s*Math.sin(e)),this.pdx=t.dx,this.pdy=t.dy,M.push(this)};F.prototype.power=function(){te.val+=2,te.val>5&&(te.val=5),te.val>2&&te.silence(),te.speed*=.7,l.s=te.val/te.speed,L.bright=1,W(6,function(){L.bright=0,te.speed/=.7,l.s=te.val/te.speed}),J(M,this),J(m,this),ee.update(1),ce.play("power",le,180)};var G=function(t){j.call(this,t),this.type="reverse",this.power=t.power;var e=(this.dx-this.x,this.dy-this.y,Math.atan2(this.dy,this.dx));this.sx=Math.abs(this.s*Math.cos(e)),this.sy=Math.abs(this.s*Math.sin(e)),this.pdx=t.dx,this.pdy=t.dy,S.push(this)};G.prototype.reverse=function(){ce.play("reverse",2*ae,150),k=!k,H(b,function(t){k?(t.pdx=t.opx,t.pdy=t.opy,t.dx=t.ox,t.dy=t.oy):(t.pdx=t.opdx,t.pdy=t.opdy,t.dx=t.odx,t.dy=t.ody);var e=t.pdx-t.px,n=t.pdy-t.py,i=Math.atan2(n,e);t.sx=Math.abs(t.s*Math.cos(i)),t.sy=Math.abs(t.s*Math.sin(i)),t.rotate*=-1}),H(C,function(t){t.s*=-1}),J(S,this),J(m,this),ee.update(-1),te.val-=1,te.val<0&&(te.val=0),te.color="#f97",W(.3,function(){te.color="white"}),L.alert||(L.alert=1,W(.3,function(){L.alert=0}))};var B=function(t){if("play"===w){var e,n=new Date,i=300>n-E,a=(t.layerX||t.clientX-c.offsetLeft)/y,o=(t.layerY||t.clientY-c.offsetTop)/p;if(E=n,t.preventDefault(),i&&te.val>=2)for(ce.play("click",re,150),te.val-=1,l.jump(a,o,!0),e=0;e<g.length;e++)g[e].jump(a+A(1,8,!0),o+A(1,8,!0));if(!i&&te.val>=2&&(te.val-=1),!i&&te.val>=3&&ce.play("click",ne,150),!i)for(l.move(a,o,!0),e=0;e<g.length;e++)g[e].move(a+A(0,4,!0),o+A(0,4,!0));te.val<=2&&te.alert()}},W=function(t,e){var n=function(){e(),J(T,this)},i=setTimeout(n.bind(i),1e3*t);return T.push(i),i},A=function(t,e,n){var i=Math.random()*(e-t)+t;return n&&Math.random()<.5&&(i*=-1),i},H=function(t,e){var n=t.length;for(n>500&&console.log("error"+n,t);n--;)e.call(t[n],t[n],n)},J=function(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)},R=function(t,e){-1==t.className.search(e)&&(0===t.className.length?t.className=e:t.className+=" "+e)},q=function(t,e){var n=t.className.split(" ");H(n,function(t){t==e&&J(n,t)}),t.className=n.join(" ")},Y={fish:function(){if("play"===w&&v.length<5){var t=new O({x:A(5,d-5),y:A(5,f-5),s:A(.2,.4),w:2.8,h:A(1.6,2.8),img:U.fish});1==$.current&&(t.x=A(d/1.3,d-5)),t.rotate=A(.01,.03,!0),t.flip=Math.random()<.5,t.px=t.x+A(1,6,!0),t.py=t.y+A(1,6,!0)}"play"===w&&W(3,Y.fish)},enemy:function(t){H(t.unit,function(e){var n=new j(e);if(n.type="enemy",n.s=t.s,n.x=t.x+e.x*t.f,n.y=t.y+e.y*t.f,n.px=t.x+t.px*t.f,n.py=t.y+t.py*t.f,t.r){n.x-=n.px,n.y-=n.py;var i=Math.cos(t.r),a=Math.sin(t.r),o=n.x*i-n.y*a,s=n.x*a+n.y*i;n.x=o+n.px,n.y=s+n.py}n.dx=t.dx+n.x*t.f,n.dy=t.dy+n.y*t.f,n.pdx=t.dx+t.px*t.f,n.pdy=t.dy+t.py*t.f,n.ox=n.x,n.oy=n.y,n.odx=n.dx,n.ody=n.dy,n.opx=n.px,n.opy=n.py,n.opdx=n.pdx,n.opdy=n.pdy,n.w=e.w*t.f,n.h=e.h*t.f||e.w*t.f,n.rotate=t.rotate;var r=n.pdx-n.px,l=n.pdy-n.py,y=Math.atan2(l,r);n.sx=Math.abs(n.s*Math.cos(y)),n.sy=Math.abs(n.s*Math.sin(y)),b.push(n)})},power:function(){if(H(M,function(t){t.y>=f&&(J(M,t),J(m,t),t=null)}),"play"===w&&M.length<3){var t=new F({x:A(10,d-10),y:-10,w:1.8,h:1.8,s:A(.15,.25)});t.stroke="white",1==$.current&&(t.x=A(d/1.3,d-5))}"play"===w&&W(4,Y.power)},reverse:function(){if(H(S,function(t){t.y>=f&&(J(S,t),J(m,t),t=null)}),"play"===w&&S.length<12){var t=new G({x:A(10,d-10),y:-10,w:2.2,h:2.2,s:A(.01,.5)});t.stroke="white"}"play"===w&&W(1.5,Y.reverse)}},_=function(){H(m,function(t){if(t.rotate){t.x-=t.px,t.y-=t.py;var e=Math.cos(t.rotate),n=Math.sin(t.rotate),i=t.x*e-t.y*n,a=t.x*n+t.y*e;t.x=i+t.px,t.y=a+t.py}"number"==typeof t.pdx&&(t.pdx>t.px+t.sx?(t.px+=t.sx,t.x+=t.sx):t.pdx<t.px-t.sx?(t.px-=t.sx,t.x-=t.sx):t.pdx=!1),"number"==typeof t.pdy&&(t.pdy>t.py+t.sy?(t.py+=t.sy,t.y+=t.sy):t.pdy<t.py-t.sy?(t.py-=t.sy,t.y-=t.sy):t.pdy=!1)})},X=function(){H(g,function(t){var e=3;l.pdx||l.pdy||(Math.abs(t.x-l.x>e)||Math.abs(t.y-l.y>e))&&t.move(l.x,l.y)})},K={check:function(){H(b,function(t){K.circ(l,t)&&L.over()}),H(M,function(t){K.rect(l,t)&&t.power()}),H(S,function(t){K.rect(l,t)&&t.reverse()}),H(v,function(t){K.rect(l,t)&&t.addToShoal()})},rect:function(t,e){return t.x-t.w/2<e.x+e.w/2&&t.x+t.w/2>e.x-e.w/2&&t.y-t.h/2<e.y+e.h/2&&t.y+t.h/2>e.y-e.h/2},circ:function(t,e){var n=Math.pow(t.x-e.x,2),i=Math.pow(t.y-e.y,2),a=Math.pow(n+i,.5),o=(t.w+e.w)/2;return o>a}},Q={thefish:["transparent","white","#9af","#28c","#268","#333"],fish:["transparent","white","#ac9","#2c7","#382","#333"],shoal:["transparent","white","#f9d","#a5e","#739","#333"],dead:["transparent","white","#aaa","#888","#555","#333"]},U={thefish:z.sprite(22,22,N,Q.thefish),shoal:z.sprite(22,22,N,Q.shoal),fish:z.sprite(22,22,N,Q.fish),dead:z.sprite(22,22,N,Q.dead)},V={frame:function(){h.clearRect(0,0,d*y,f*p),h.fillStyle="over"==w?"rgba(255,255,255,0.1)":L.alert?"rgba(240,150,220,0.2)":L.bright?"rgba(180,250,255,0.2)":"rgba(50,240,255,0.2)",h.fillRect(0,0,d*y,f*p),h.fillStyle="rgba(255,255,255,0.3)",V.bubbles(),V.splash(),("play"===w||"win"===w)&&(_(),X(),K.check()),V.enemies(),V.breath(),V.powers(),V.reverses(),H(v,V.fish),l&&V.fish.call(l),H(g,V.fish),requestAnimationFrame(V.frame)},fish:function(){var t=(this.x-this.w/2)*y,e=(this.y-this.h/2)*p,n=this.w*y,i=this.h*p,a=this.img;"over"==w&&(a=U.dead),this.flip?(h.save(),h.translate(this.w*y,0),h.scale(-1,1),h.drawImage(a,-1*t,e,n,i),h.restore()):h.drawImage(a,t,e,n,i)},circle:function(t){h.beginPath(),h.arc(t.x*y,t.y*p,t.w/2*y,0,2*Math.PI),h.fill(),t.stroke&&(h.lineWidth=t.w/6*y,h.strokeStyle=t.stroke,h.stroke())},bubbles:function(){"resize"!=w&&H(C,function(t){t.y-=t.s,t.x+=Math.sin((t.y+t.r)/10)/20,t.y<-10&&(t.y=f+t.w,t.x=A(5,d-5)),t.y>f+10&&(t.y=-t.w,t.x=A(5,d-5))}),H(C,V.circle)},splash:function(){"resize"!=w&&H(P,function(t){t.x+=t.sx,t.y+=t.sy,t.w-=.1,t.w<=0&&(J(P,t),t=null)}),H(P,V.circle)},enemies:function(){h.fillStyle="over"==w?"#bbb":ce.playing?"#F80":"orange",H(b,V.circle)},powers:function(){h.fillStyle="over"==w?"#ccc":"limegreen","play"===w&&H(M,function(t){t.y+=t.s,t.x+=Math.sin(t.y/2)/15}),H(M,V.circle)},reverses:function(){h.fillStyle="over"==w?"#bbb":"tomato","play"===w&&H(S,function(t){t.y+=t.s,t.x+=Math.sin(t.y/2)/15}),H(S,V.circle)},breath:function(){if("play"===w){var t;for(h.beginPath(),h.moveTo((te.x+te.w/2)*y,te.y*p),h.arc(te.x*y,te.y*p,te.w/2*y,Math.PI,2*Math.PI),h.lineCap="round",h.lineWidth=2*y,h.strokeStyle=te.color,h.stroke(),t=0;t<te.max;t++)h.beginPath(),h.moveTo(te.x*y,te.y*p),h.arc(te.x*y,te.y*p,te.w/2*y,Math.PI+1*Math.PI/5*t,Math.PI+1*Math.PI/5*(t+1)),h.fillStyle=t<te.val?te.colors[t]:"rgba(155,155,155,0.3)",h.fill();h.beginPath(),h.arc(te.x*y,te.y*p,te.w/4*y,0,2*Math.PI),h.fillStyle=te.color,h.fill()}}},Z={smallstar:[{x:50,y:50,w:20},{x:50,y:-3,w:10},{x:50,y:12,w:14},{x:50,y:30,w:18},{x:0,y:36,w:10},{x:14,y:40,w:14},{x:30,y:46,w:18},{x:100,y:36,w:10},{x:86,y:40,w:14},{x:70,y:46,w:18},{x:20,y:100,w:10},{x:28,y:87,w:14},{x:38,y:69,w:18},{x:80,y:100,w:10},{x:72,y:87,w:14},{x:62,y:69,w:18}],star:[{x:50,y:50,w:10},{x:50,y:0,w:5},{x:55,y:6,w:5},{x:45,y:6,w:5},{x:57,y:14,w:6},{x:43,y:14,w:6},{x:58,y:22,w:7},{x:42,y:22,w:7},{x:61,y:31,w:7},{x:39,y:31,w:7},{x:0,y:34,w:5},{x:2,y:41,w:5},{x:7,y:33,w:5},{x:9,y:46,w:6},{x:14,y:35,w:6},{x:16,y:51,w:7},{x:22,y:36,w:7},{x:24,y:56,w:7},{x:31,y:37,w:7},{x:100,y:34,w:5},{x:98,y:41,w:5},{x:93,y:33,w:5},{x:91,y:46,w:6},{x:86,y:35,w:6},{x:84,y:51,w:7},{x:78,y:36,w:7},{x:76,y:56,w:7},{x:69,y:37,w:7},{x:18,y:100,w:5},{x:17,y:93,w:5},{x:25,y:99,w:5},{x:19,y:85,w:6},{x:33,y:94,w:6},{x:21,y:76,w:7},{x:39,y:87,w:7},{x:24,y:66,w:7},{x:44,y:80,w:7},{x:82,y:100,w:5},{x:83,y:93,w:5},{x:75,y:99,w:5},{x:81,y:85,w:6},{x:67,y:94,w:6},{x:79,y:76,w:7},{x:61,y:87,w:7},{x:76,y:66,w:7},{x:56,y:80,w:7},{x:50,y:72,w:7}],anchor:[{x:0,y:0,w:6},{x:-5,y:6,w:7},{x:8,y:1,w:6},{x:-5,y:14,w:7},{x:14,y:7,w:6},{x:2,y:19,w:6},{x:14,y:14,w:6},{x:10,y:20,w:6},{x:15,y:29,w:10},{x:20,y:40,w:9},{x:10,y:44,w:8},{x:30,y:36,w:8},{x:25,y:50,w:9},{x:30,y:60,w:8},{x:35,y:70,w:7},{x:40,y:80,w:8},{x:45,y:90,w:8},{x:51,y:102,w:10},{x:40,y:100,w:8},{x:56,y:93,w:7},{x:31,y:97,w:7},{x:60,y:85,w:6},{x:23,y:97,w:6},{x:65,y:80,w:5},{x:16,y:98,w:5},{x:70,y:76,w:5},{x:8,y:96,w:7},{x:73,y:70,w:6}],shell:[{x:0,y:46,w:5},{x:6,y:49,w:5},{x:12,y:53,w:6},{x:18,y:59,w:7},{x:20,y:52,w:5},{x:6,y:41,w:6},{x:13,y:36,w:7},{x:21,y:34,w:7},{x:29,y:36,w:7},{x:37,y:38,w:7},{x:46,y:42,w:8},{x:36,y:47,w:8},{x:28,y:55,w:8},{x:25,y:66,w:8},{x:55,y:46,w:7},{x:46,y:51,w:7},{x:39,y:57,w:7},{x:36,y:66,w:7},{x:63,y:49,w:6},{x:56,y:54,w:6},{x:50,y:59,w:6},{x:46,y:66,w:6},{x:71,y:52,w:6},{x:63,y:58,w:6},{x:58,y:65,w:6},{x:78,y:55,w:5},{x:72,y:59,w:5},{x:68,y:65,w:5},{x:84,y:58,w:5},{x:78,y:64,w:5},{x:85,y:64,w:4},{x:90,y:62,w:4}]},$={current:0,build:function(){L.clear(),l=new O({s:.5,x:d/2,y:f/2,w:5,img:U.thefish},!0),$.lvls[$.current].enemies&&H($.lvls[$.current].enemies,function(t){t.t?W(t.t,Y.enemy.bind(this,t)):Y.enemy(t)}),w="play",$.current>=1&&Y.power(),Y.reverse(),W(3,Y.fish),ee.start(),te.recover()},lvls:[{score:3,enemies:[{f:.2,x:30,y:10,dx:45,dy:35,unit:Z.smallstar,rotate:.015,px:10,py:50},{f:.1,x:70,y:40,dx:55,dy:35,unit:Z.smallstar,rotate:-.03,px:95,py:50}]},{score:3,enemies:[{s:.1,f:.2,x:55,y:0,dx:45,dy:0,unit:Z.smallstar,rotate:-.01,px:50,py:50},{s:.2,f:.1,x:65,y:20,dx:55,dy:20,unit:Z.smallstar,rotate:.02,px:50,py:50},{s:.2,f:.18,x:68,y:30,dx:58,dy:30,unit:Z.smallstar,rotate:-.02,px:50,py:50},{s:.1,f:.15,x:67,y:50,dx:57,dy:50,unit:Z.smallstar,rotate:.01,px:50,py:50},{s:.2,f:.1,x:65,y:65,dx:55,dy:65,unit:Z.smallstar,rotate:-.01,px:50,py:50}]},{score:5,enemies:[{s:.2,f:.2,x:-50,y:0,dx:150,dy:0,unit:Z.shell,px:50,py:50},{s:.25,f:.15,x:150,y:20,dx:-50,dy:20,unit:Z.shell,r:Math.PI,px:50,py:50},{s:.3,f:.25,x:150,y:30,dx:-50,dy:30,unit:Z.shell,r:Math.PI,px:50,py:50},{s:.25,f:.3,x:-50,y:40,dx:150,dy:40,unit:Z.shell,px:50,py:50},{s:.3,t:5,f:.2,x:-50,y:60,dx:150,dy:60,unit:Z.shell,px:50,py:50}]},{score:10,enemies:[{s:.4,f:.2,x:60,y:-100,dx:55,dy:55,unit:Z.anchor,px:50,py:50},{s:.4,f:.3,x:20,y:45,dx:25,dy:-100,unit:Z.anchor,px:50,py:50},{t:6,s:.4,f:.45,x:70,y:-100,dx:75,dy:30,unit:Z.anchor,px:50,py:50},{t:10,s:.4,f:.2,x:0,y:-100,dx:0,dy:45,unit:Z.anchor,px:50,py:50}]},{score:15,enemies:[{s:.4,f:.3,x:20,y:-100,dx:25,dy:45,unit:Z.anchor,px:50,py:50},{s:.2,f:.3,x:-50,y:10,dx:85,dy:60,unit:Z.star,rotate:.01,px:50,py:50},{t:2,s:.5,f:.1,x:120,y:5,dx:30,dy:5,unit:Z.smallstar,rotate:-.01,px:50,py:50},{t:6,s:.4,f:.35,x:60,y:-100,dx:65,dy:40,unit:Z.anchor,px:50,py:50},{s:.1,f:.5,x:-20,y:-10,dx:150,dy:70,unit:Z.shell,px:50,py:50}]},{score:20,enemies:[{s:.1,f:1.4,x:10,y:0,dx:100,dy:60,unit:Z.smallstar,rotate:-.004,px:50,py:50},{s:.15,f:2,x:-180,y:-180,dx:-20,dy:-10,unit:Z.star,rotate:-.003,px:50,py:50}]}]},te={x:11,y:f-1,w:20,max:5,val:5,time:1.2,speed:10,color:"white",colors:["rgba(232, 98, 60, 0.8)","rgba(232, 168, 60, 0.8)","rgba(112, 198, 110, 0.8)","rgba(32, 178, 170, 0.8)","rgba(92, 148, 180, 0.8)"],recover:function(){"play"===w&&(te.val<te.max&&(te.val+=1,te.val>2&&te.silence(),l.s=te.val/te.speed,l.pdx&&l.pdy&&l.move(l.pdx,l.pdy)),W(te.time,te.recover))},reset:function(){te.val=5,te.time=1.2,te.speed=10,te.val=te.max},alert:function(){ce.playing||(L.alert=1,ce.playing=1,ce.playSong())},silence:function(){L.alert=0,ce.playing=0,clearTimeout(ce.t),ce.t=!1,ce.play("song")}},ee={val:0,total:0,totaltime:0,start:function(){ee.val=0,ee.el.textContent=ee.val,ee.begin=new Date,ee.update()},stop:function(){ee.end=new Date;var t=ee.end-ee.begin;ee.time=t/1e3,ee.totaltime+=ee.time,ee.total+=ee.val},update:function(t){"play"===w&&(t&&(ee.val+=t,ee.val<0&&(ee.val=0),ee.el.textContent=ee.val),te.el.textContent=g.length+"/"+$.lvls[$.current].score,g.length>=$.lvls[$.current].score&&L.win())},load:function(){if(window.localStorage){var t=localStorage.getItem("kfish highscores");t&&(i.data=JSON.parse(t))}},save:function(){window.localStorage&&localStorage.setItem("kfish highscores",JSON.stringify(i.data))},highscore:function(t,e,n){i.data.push({name:t,points:e,time:n}),i.data.sort(function(t,e){return e.points-t.points}),i.data=i.data.slice(0,7),ee.save(),ee.build()},build:function(){i.empty();var t=[];H(i.data,function(e){t.push("<p>"+e.name+" ... "+e.points+" / "+e.time.toFixed(2)+" sec</p>")}),t.reverse(),i.text(t),i.button("Back",function(){e.show(),i.up()})}},ne=261.63,ie=277.18,ae=293.66,oe=329.63,se=349.23,re=392,le=440,ye=466.16,pe=493.88,ce={muteStr:"Mute",playStr:"Play",ms:150,song:[pe/2,4,oe/2,4,pe/2,4,oe/2,4,pe,2,ye,2,pe,2,2*ie,2,pe,8],playSong:function(){L.audio&&(ce.state=0,ce.sing())},sing:function(){if(L.audio){ce.play("song",ce.song[ce.state]);var t=ce.song[ce.state+1]*ce.ms;ce.t=setTimeout(ce.sing,t),ce.state<ce.song.length-2?ce.state+=2:(setTimeout(function(){ce.play("song")},t/2),ce.state=0)}},play:function(t,e,n){if(L.audio&&!ce.muted){var i=1;e>400&&(i=.15),ce.gainNode.gain.value=i,ce.oscillator.frequency.value=e||0,n&&!ce.t&&setTimeout(ce.play,n)}},mute:function(){ce.muted?(ce.el.textContent=ce.muteStr,ce.muted=!1):(ce.gainNode.gain.value=0,ce.el.textContent=ce.playStr,ce.muted=!0),ce.save()},load:function(){if(window.localStorage){var t=localStorage.getItem("kfish mute");t&&(ce.muted=JSON.parse(t))}},save:function(){window.localStorage&&localStorage.setItem("kfish mute",JSON.stringify(ce.muted))}};L.start()};window.addEventListener("load",Game);